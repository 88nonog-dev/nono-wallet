<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nono Wallet</title>
  <style>
    :root{--bg:#0b1020;--card:#121a2e;--txt:#eaf1ff;--muted:#9fb3d9;--acc:#3ea6ff;--ok:#34c759;--err:#ff453a}
    *{box-sizing:border-box}
    body{background:linear-gradient(180deg,#0b1020 0%,#0f1530 100%);color:var(--txt);font-family:system-ui,Segoe UI,Arial;max-width:980px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h2{margin:0}
    .badge{padding:6px 10px;border-radius:999px;background:#0e243d;color:var(--acc);border:1px solid #1d3352}
    .card{background:var(--card);border:1px solid #1d2a45;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{color:var(--muted)}
    input,button{padding:10px 12px;border-radius:12px;border:1px solid #253a63;background:#0e1a35;color:var(--txt)}
    input{min-width:120px}
    button{cursor:pointer;background:#13224a}
    button:hover{background:#183061}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #1d2a45;padding:9px;text-align:right;color:#d8e4ff}
    th{color:var(--muted);font-weight:600}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid #264d7a}
    .pill.dep{color:#74ff9c;background:#0f2a1b} .pill.wd{color:#ffd280;background:#2b1a07}
  </style>
</head>
<body>
  <header>
    <h2>محفظة نونو</h2>
    <div class="badge" id="status">جاهز</div>
  </header>

  <div class="card">
    <div class="row">
      <label>المحفظة (ID)</label>
      <input id="wid" type="number" placeholder="مثال: 1" />
      <button id="btnHealth">فحص /health</button>
      <button id="btnLoad">عرض الرصيد</button>
      <div><strong>الرصيد:</strong> <span id="balance">—</span></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>المبلغ</label>
      <input id="amount" type="number" step="0.01" placeholder="مثال: 50" />
      <button id="btnDeposit">إيداع</button>
      <button id="btnWithdraw">سحب</button>
      <button id="btnExport">تصدير CSV</button>
    </div>
  </div>

  <div class="card">
    <div class="row"><button id="btnTx">تحديث جدول الحركات</button></div>
    <table id="txTable">
      <thead><tr><th>الوقت</th><th>النوع</th><th>المبلغ</th><th>ID</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const S = (id)=>document.getElementById(id);
const statusEl = S('status');
const API_TOKEN = {{ api_token|tojson }};

function setStatus(msg, ok=true){ statusEl.textContent=msg; statusEl.className = ok? 'badge ok':'badge err'; }

async function call(path, opts={}){
  const headers = Object.assign({
    'Content-Type':'application/json',
    'X-Api-Token': API_TOKEN,
    'Idempotency-Key': crypto.randomUUID()
  }, opts.headers||{});
  const res = await fetch(path, Object.assign({}, opts, {headers}));
  const text = await res.text();
  let json; try{ json=JSON.parse(text);}catch{ json={raw:text}; }
  if(!res.ok) throw new Error(json.error||text||res.statusText);
  return json;
}

S('btnHealth').onclick = async ()=>{
  try{ const j = await fetch('/health').then(r=>r.json()); setStatus(j.ok?'الصحة OK':'health NG', !!j.ok); }
  catch(e){ setStatus(e.message,false); }
};

S('btnLoad').onclick = async ()=>{
  const wid = Number(S('wid').value); if(!wid) return setStatus('أدخل Wallet ID',false);
  try{ const j = await fetch(`/wallet/balance?wallet_id=${wid}`).then(r=>r.json());
       if(j.ok){ S('balance').textContent = j.balance; setStatus('تم جلب الرصيد'); } else setStatus(j.error||'خطأ',false); }
  catch(e){ setStatus(e.message,false); }
};

async function mutate(kind){
  const wid = Number(S('wid').value), amt = Number(S('amount').value);
  if(!wid) return setStatus('أدخل Wallet ID',false);
  if(!amt || amt<=0) return setStatus('أدخل مبلغ صحيح',false);
  try{
    const j = await call(`/wallet/${kind}`, {method:'POST', body: JSON.stringify({wallet_id: wid, amount: amt})});
    if(j.ok){ S('balance').textContent=j.balance; setStatus(kind==='deposit'?'تم الإيداع':'تم السحب'); await loadTx(); }
    else setStatus(j.error||'خطأ',false);
  }catch(e){ setStatus(e.message,false); }
}
S('btnDeposit').onclick = ()=>mutate('deposit');
S('btnWithdraw').onclick = ()=>mutate('withdraw');

async function loadTx(){
  const wid = Number(S('wid').value); if(!wid) return setStatus('أدخل Wallet ID',false);
  try{
    const j = await fetch(`/transactions?wallet_id=${wid}`).then(r=>r.json());
    const tb = S('txTable').querySelector('tbody'); tb.innerHTML='';
    if(j.ok && Array.isArray(j.items)){
      for(const t of j.items){
        const tr=document.createElement('tr');
        const pill = t.tx_type==='deposit' ? '<span class="pill dep">إيداع</span>' : '<span class="pill wd">سحب</span>';
        tr.innerHTML = `<td>${t.created_at}</td><td>${pill}</td><td>${t.amount}</td><td>${t.id}</td>`;
        tb.appendChild(tr);
      }
      setStatus('تم تحديث الجدول');
    }else setStatus(j.error||'لا توجد بيانات',false);
  }catch(e){ setStatus(e.message,false); }
}
S('btnTx').onclick = loadTx;

S('btnExport').onclick = ()=>{
  const wid = Number(S('wid').value); if(!wid) return setStatus('أدخل Wallet ID',false);
  const a = document.createElement('a'); a.href=`/export/csv?wallet_id=${wid}`; a.download=`wallet_${wid}.csv`; a.click();
  setStatus('تم تنزيل CSV');
};
</script>
</body>
</html>
