<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nono Wallet - Dashboard (Auto KPIs + Currency)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#141b34; --border:#2a355f; --text:#f2f5ff; --muted:#9fb0ff;
      --input:#0f1630; --brand:#1b6bff; --brand2:#2e77ff; --ok:#7ff0b2; --okbg:#0e4b2d; --bad:#ff99a6; --badbg:#4b0e17;
    }
    [data-theme="light"]{
      --bg:#f7f9ff; --card:#ffffff; --border:#e5e9f6; --text:#0f1730; --muted:#5a6aa8;
      --input:#f1f4ff; --brand:#2a66ff; --brand2:#1a59ff; --ok:#0f7a49; --okbg:#c8f5e2; --bad:#b01c38; --badbg:#ffd8df;
    }
    *{box-sizing:border-box}
    body { font-family: system-ui, -apple-system, Segoe UI, Tahoma, Arial; background:var(--bg); color:var(--text); margin:0; }
    .wrap { max-width: 1060px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 24px; margin: 0 0 16px; display:flex; align-items:center; gap:12px; }
    .brand { width:28px; height:28px; border-radius:6px; background:linear-gradient(135deg, var(--brand), var(--brand2)); display:inline-block }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 18px rgba(0,0,0,0.12);}
    .row { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 12px; }
    label { font-size: 13px; color:var(--muted); display:block; margin-bottom: 6px; }
    input, select, button, textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background:var(--input); color:var(--text); outline: none;
    }
    input::placeholder, textarea::placeholder { color:#92a0d1; }
    button { cursor: pointer; font-weight: 600; }
    .btn { background: var(--brand); border: 1px solid var(--brand2); color:#fff; }
    .btn.secondary{ background:transparent }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .muted { color:var(--muted); font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px; font-size: 13px; text-align: right; }
    th { color:var(--muted); font-weight: 600; position: sticky; top: 0; background: var(--input); }
    .pill { display:inline-block; padding:4px 8px; border-radius: 999px; font-size:12px; }
    .pill.in { background:var(--okbg); color:var(--ok); }
    .pill.out { background:var(--badbg); color:var(--bad); }
    .flex { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    .space { height: 6px; }
    .foot { margin-top: 10px; display:flex; justify-content: space-between; align-items:center; }
    a.link { color:#7fb3ff; text-decoration: none; }
    .mini{padding:8px 10px; font-size:12px}
    .copy-wrap{display:flex; gap:8px}
    .kpis{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px}
    .kpi{background:var(--input); border:1px solid var(--border); border-radius:12px; padding:12px}
    .kpi h3{margin:0 0 6px; font-size:13px; color:var(--muted)}
    .kpi .v{font-size:20px; font-weight:700}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    .switch{border:1px solid var(--border); border-radius:10px; padding:8px 12px; background:var(--input)}
    .toast{position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#111a; color:#fff; padding:10px 14px; border-radius:10px; backdrop-filter: blur(8px); opacity:0; pointer-events:none; transition:opacity .2s}
    .toast.show{opacity:1}
    .spinner{position:fixed; inset:0; background:#0004; display:none; align-items:center; justify-content:center; z-index:999}
    .spinner.show{display:flex}
    .spin{width:36px; height:36px; border-radius:50%; border:4px solid #fff6; border-top-color:#fff; animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1><span class="brand"></span> لوحة نونو وِلت (MVP)</h1>
      <button id="themeBtn" class="switch">تبديل السمة (فاتح/داكن)</button>
    </div>

    <!-- KPIs + Currency -->
    <div class="card">
      <div class="row" style="align-items:end">
        <div style="grid-column:1 / -1">
          <div class="kpis">
            <div class="kpi"><h3>إجمالي الإيداعات</h3><div class="v" id="kDeposit">0.00 IQD</div></div>
            <div class="kpi"><h3>إجمالي السحوبات</h3><div class="v" id="kWithdraw">0.00 IQD</div></div>
            <div class="kpi"><h3>صافي التدفق</h3><div class="v" id="kNet">0.00 IQD</div></div>
          </div>
          <div class="muted">تُحدَّث تلقائيًا بعد أي عملية، ويمكنك تغيير العملة للعرض فقط.</div>
        </div>
        <div>
          <label>العملة (عرض فقط)</label>
          <select id="currency">
            <option value="IQD" selected>IQD</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="TRY">TRY</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>API Token (الهيدر X-Api-Key)</label>
          <div class="copy-wrap">
            <input id="apiKey" placeholder="ادخل مفتاح API" />
            <button class="mini" id="copyApi">نسخ</button>
          </div>
          <div class="muted">يُحفَظ محليًا في المتصفح (localStorage)</div>
        </div>
        <div>
          <label>Wallet ID (معرّف المحفظة)</label>
          <div class="copy-wrap">
            <input id="walletId" placeholder="UUID لمحفظتك" />
            <button class="mini" id="copyWallet">نسخ</button>
          </div>
          <div class="flex" style="margin-top:6px">
            <button class="btn" id="btnCreate">إنشاء محفظة</button>
            <button class="secondary" id="btnSaveIds">حفظ</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>مبلغ</label>
          <input id="amount" type="number" step="0.01" placeholder="مثال: 200" />
          <div class="muted">يجب أن يكون &gt; 0</div>
        </div>
        <div>
          <label>عمليات على المحفظة</label>
          <div class="flex">
            <button class="btn" id="btnDeposit">إيداع</button>
            <button id="btnWithdraw">سحب</button>
            <button id="btnBalance">عرض الرصيد</button>
          </div>
          <div class="space"></div>
          <label>تحويل إلى محفظة أخرى</label>
          <div class="copy-wrap">
            <input id="toWallet" placeholder="To Wallet ID" />
            <button class="mini" id="copyToWallet">نسخ</button>
          </div>
          <div class="space"></div>
          <button id="btnTransfer">تحويل</button>
        </div>
      </div>
      <div class="foot">
        <div class="muted" id="status">جاهز</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>فلترة السجل</label>
          <div class="row">
            <div>
              <label>Type</label>
              <select id="type">
                <option value="">الكل</option>
                <option value="deposit">deposit</option>
                <option value="withdraw">withdraw</option>
                <option value="transfer_in">transfer_in</option>
                <option value="transfer_out">transfer_out</option>
              </select>
            </div>
            <div>
              <label>من وقت (ISO)</label>
              <input id="from" placeholder="2025-09-01T00:00:00Z" />
            </div>
            <div>
              <label>إلى وقت (ISO)</label>
              <input id="to" placeholder="2025-09-01T23:59:59Z" />
            </div>
          </div>
          <div class="space"></div>
          <div class="flex">
            <button class="btn" id="btnLoad">تحميل السجل</button>
            <button id="btnCsv">تنزيل CSV</button>
          </div>
        </div>
      </div>
      <div class="space"></div>
      <div style="max-height: 360px; overflow: auto;">
        <table id="grid">
          <thead>
            <tr>
              <th>id</th>
              <th>type</th>
              <th>amount</th>
              <th>created_at</th>
              <th>counterparty</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>طلبات السحب (Withdrawals)</h3>
      <div class="row">
        <div>
          <label>طريقة السحب</label>
          <select id="wdMethod">
            <option value="western_union">Western Union</option>
            <option value="qi_card">Qi Card (يدوي)</option>
          </select>
        </div>
        <div>
          <label>اسم المستفيد</label>
          <div class="copy-wrap">
            <input id="wdName" placeholder="الاسم الكامل" />
            <button class="mini" id="copyWdName">نسخ</button>
          </div>
        </div>
        <div>
          <label>تفاصيل/فرع/ملاحظة</label>
          <input id="wdDetails" placeholder="Baghdad branch" />
        </div>
      </div>
      <div class="space"></div>
      <div class="flex">
        <button class="btn" id="btnWdCreate">إنشاء طلب سحب</button>
        <button id="btnWdList">عرض الطلبات</button>
      </div>
      <div class="space"></div>
      <div class="row">
        <div>
          <label>Withdrawal ID</label>
          <div class="copy-wrap">
            <input id="wdId" placeholder="معرّف طلب السحب" />
            <button class="mini" id="copyWdId">نسخ</button>
          </div>
        </div>
        <div>
          <label>Payment Reference</label>
          <input id="wdRef" placeholder="WU-REF-12345" />
        </div>
        <div style="align-self:end">
          <button id="btnWdPaid">تعليم كمدفوع</button>
        </div>
      </div>
    </div>

    <div class="muted">© Nono Wallet MVP</div>
  </div>

  <!-- Toast + Spinner -->
  <div class="toast" id="toast">تم</div>
  <div class="spinner" id="spinner"><div class="spin"></div></div>

  <script>
    const base = window.location.origin;
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const gridBody = $("grid").querySelector("tbody");
    const toast = $("toast");
    const spinner = $("spinner");

    (function restore() {
      $("apiKey").value = localStorage.getItem("apiKey") || "";
      $("walletId").value = localStorage.getItem("walletId") || "";
      document.documentElement.dataset.theme = localStorage.getItem("theme") || "dark";
      $("currency").value = localStorage.getItem("currency") || "IQD";
    })();

    $("themeBtn").onclick = () => {
      const cur = document.documentElement.dataset.theme;
      const next = cur === "dark" ? "light" : "dark";
      document.documentElement.dataset.theme = next;
      localStorage.setItem("theme", next);
      tip(`تم التبديل إلى سمة ${next === "dark" ? "داكنة" : "فاتحة"}`);
    };
    $("currency").onchange = () => {
      localStorage.setItem("currency", $("currency").value);
      // إعادة عرض القيم الحالية بالعملة الجديدة
      renderKpis(lastItems);
      tip("تم تغيير العملة (عرض فقط)");
    };

    $("btnSaveIds").onclick = () => {
      localStorage.setItem("apiKey", $("apiKey").value.trim());
      localStorage.setItem("walletId", $("walletId").value.trim());
      tip("تم الحفظ محليًا");
    };
    function copy(elId){
      const v = $(elId).value.trim();
      if(!v) return tip("لا يوجد نص للنسخ");
      navigator.clipboard.writeText(v).then(()=> tip("تم النسخ")).catch(()=> tip("تعذّر النسخ"));
    }
    $("copyApi").onclick = ()=>copy("apiKey");
    $("copyWallet").onclick = ()=>copy("walletId");
    $("copyToWallet").onclick = ()=>copy("toWallet");
    $("copyWdName").onclick = ()=>copy("wdName");
    $("copyWdId").onclick = ()=>copy("wdId");

    function hdrs() {
      const k = $("apiKey").value.trim();
      return { "Content-Type": "application/json", "X-Api-Key": k };
    }
    const wid = () => $("walletId").value.trim();
    const amt = () => Number($("amount").value);
    const note = (msg) => statusEl.textContent = msg;
    const showSpin = (b)=> spinner.classList.toggle("show", b);
    let toastTimer=null;
    function tip(msg){
      toast.textContent=msg; toast.classList.add("show");
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer=setTimeout(()=> toast.classList.remove("show"), 1800);
      note(msg);
    }

    function fmt(n){ return Number(n).toFixed(2); }
    function cur(){ return $("currency").value; }
    function fmtc(n){ return `${fmt(n)} ${cur()}`; }

    function rowTx(r) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><code>${r.id}</code></td>
        <td>${pill(r.type)}</td>
        <td>${fmtc(r.amount)}</td>
        <td>${r.created_at}</td>
        <td>${r.counterparty_wallet_id || ""}</td>`;
      return tr;
    }
    function pill(type) {
      const cls = (type === "deposit" || type === "transfer_in") ? "in" : "out";
      return `<span class="pill ${cls}">${type}</span>`;
    }

    async function http(url, opts={}) {
      showSpin(true);
      try{
        const res = await fetch(url, opts);
        if (!res.ok) {
          const t = await res.text().catch(()=> "");
          throw new Error(`HTTP ${res.status}: ${t}`);
        }
        const ct = res.headers.get("content-type") || "";
        if (ct.includes("application/json")) return res.json();
        return res.blob();
      } finally {
        showSpin(false);
      }
    }

    function ensureWallet(){ if(!wid()){ tip("أدخل Wallet ID"); return false } return true }
    function ensureAmount(){
      const a = amt();
      if(!(a>0)){ tip("المبلغ يجب أن يكون أكبر من 0"); return false }
      return true;
    }

    // حفظ آخر قائمة معاملات لتحديث KPIs بدون إعادة طلب إذا تغيرت العملة
    let lastItems = [];

    function renderKpis(items){
      let dep=0, wd=0;
      for(const r of items){
        const a = Number(r.amount)||0;
        if(r.type==="deposit" || r.type==="transfer_in") dep += a;
        if(r.type==="withdraw" || r.type==="transfer_out") wd  += a;
      }
      const net = dep - wd;
      $("kDeposit").textContent = fmtc(dep);
      $("kWithdraw").textContent = fmtc(wd);
      $("kNet").textContent = fmtc(net);
    }

    async function loadTx(){
      if(!ensureWallet()) return;
      const t = $("type").value.trim();
      const f = $("from").value.trim();
      const to = $("to").value.trim();
      const qs = new URLSearchParams({ wallet_id: wid() });
      if (t) qs.set("type", t);
      if (f) qs.set("from", f);
      if (to) qs.set("to", to);

      const data = await http(`${base}/transactions?${qs.toString()}`, { headers: hdrs() });
      lastItems = data.items || [];
      gridBody.innerHTML = "";
      lastItems.forEach(r => gridBody.appendChild(rowTx(r)));
      renderKpis(lastItems);
      tip(`تم تحميل ${data.count} عملية`);
    }

    $("btnLoad").onclick = () => loadTx();

    $("btnCsv").onclick = async () => {
      if(!ensureWallet()) return;
      const t = $("type").value.trim();
      const f = $("from").value.trim();
      const to = $("to").value.trim();
      const qs = new URLSearchParams({ wallet_id: wid() });
      if (t) qs.set("type", t);
      if (f) qs.set("from", f);
      if (to) qs.set("to", to);
      try {
        const blob = await http(`${base}/transactions/export.csv?${qs.toString()}`, { headers: hdrs() });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `transactions_${wid()}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        tip("تم تنزيل CSV");
      } catch (e) { tip(e.message); }
    };

    // عمليات المحفظة
    $("btnCreate").onclick = async () => {
      try {
        const data = await http(`${base}/wallet/create`, { method: "POST", headers: hdrs() });
        $("walletId").value = data.wallet_id;
        localStorage.setItem("walletId", data.wallet_id);
        tip(`تم إنشاء محفظة: ${data.wallet_id}`);
        await loadTx();
      } catch (e) { tip(e.message); }
    };

    $("btnDeposit").onclick = async () => {
      if(!ensureWallet() || !ensureAmount()) return;
      try {
        const data = await http(`${base}/wallet/deposit`, {
          method: "POST", headers: hdrs(),
          body: JSON.stringify({ wallet_id: wid(), amount: amt() })
        });
        tip(`الرصيد: ${fmtc(data.balance)}`);
        await loadTx();
      } catch (e) { tip(e.message); }
    };

    $("btnWithdraw").onclick = async () => {
      if(!ensureWallet() || !ensureAmount()) return;
      try {
        const data = await http(`${base}/wallet/withdraw`, {
          method: "POST", headers: hdrs(),
          body: JSON.stringify({ wallet_id: wid(), amount: amt() })
        });
        tip(`الرصيد: ${fmtc(data.balance)}`);
        await loadTx();
      } catch (e) { tip(e.message); }
    };

    $("btnBalance").onclick = async () => {
      if(!ensureWallet()) return;
      try {
        const url = `${base}/wallet/balance?wallet_id=${encodeURIComponent(wid())}`;
        const data = await http(url, { headers: hdrs() });
        tip(`الرصيد الحالي: ${fmtc(data.balance)}`);
      } catch (e) { tip(e.message); }
    };

    $("btnTransfer").onclick = async () => {
      if(!ensureWallet() || !ensureAmount()) return;
      const to = $("toWallet").value.trim();
      if(!to){ tip("أدخل To Wallet ID"); return }
      try {
        const data = await http(`${base}/wallet/transfer`, {
          method: "POST", headers: hdrs(),
          body: JSON.stringify({ from_wallet_id: wid(), to_wallet_id: to, amount: amt() })
        });
        tip(`تحويل ناجح: ${fmtc(data.amount)} → رصيدك: ${fmtc(data.from_balance)}`);
        await loadTx();
      } catch (e) { tip(e.message); }
    };

    // Withdrawals
    $("btnWdCreate").onclick = async () => {
      if(!ensureWallet() || !ensureAmount()) return;
      try {
        const body = {
          wallet_id: wid(),
          amount: amt(),
          method: $("wdMethod").value,
          beneficiary_name: $("wdName").value.trim(),
          details: $("wdDetails").value.trim()
        };
        const data = await http(`${base}/withdrawal/create`, {
          method: "POST", headers: hdrs(), body: JSON.stringify(body)
        });
        $("wdId").value = data.withdrawal_id;
        tip(`إنشاء طلب: ${data.withdrawal_id} (${data.status})`);
        await loadTx();
      } catch (e) { tip(e.message); }
    };

    $("btnWdList").onclick = async () => {
      if(!ensureWallet()) return;
      try {
        const data = await http(`${base}/withdrawal/list?wallet_id=${encodeURIComponent(wid())}`, { headers: hdrs() });
        gridBody.innerHTML = "";
        data.items.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><code>${r.id}</code></td>
            <td><span class="pill out">withdraw(${r.status})</span></td>
            <td>${fmtc(r.amount)}</td>
            <td>${r.created_at}</td>
            <td>${r.method} ${r.payment_reference ? "(" + r.payment_reference + ")" : ""}</td>`;
          gridBody.appendChild(tr);
        });
        tip(`طلبات: ${data.count}`);
      } catch (e) { tip(e.message); }
    };

    $("btnWdPaid").onclick = async () => {
      if(!$("wdId").value.trim()){ tip("أدخل Withdrawal ID"); return }
      try {
        const body = {
          withdrawal_id: $("wdId").value.trim(),
          payment_reference: $("wdRef").value.trim()
        };
        const data = await http(`${base}/withdrawal/mark_paid`, {
          method: "POST", headers: hdrs(), body: JSON.stringify(body)
        });
        tip(`تم تعليم مدفوع: الرصيد الآن ${fmtc(data.balance)}`);
        await loadTx();
      } catch (e) { tip(e.message); }
    };

    // تحميل أولي للسجل إذا كان Wallet ID محفوظ
    if(wid()){ loadTx(); }
  </script>
</body>
</html>
